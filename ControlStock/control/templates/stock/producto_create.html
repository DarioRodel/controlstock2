{% load custom_filters %}
{% load static %}
{% load widget_tweaks %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if form.instance.pk %}Editar Producto{% else %}Nuevo Producto{% endif %}</title>
    <!-- Bootstrap & FontAwesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Quagga (si lo usas) -->
    <link href="https://cdn.jsdelivr.net/npm/quagga/dist/quagga.min.css" rel="stylesheet">
    <!-- Tus CSS -->
    <link rel="stylesheet" href="{% static 'css/producto_create.css' %}">
    <!-- Darkmode -->
    <script src="{% static 'dark/js/darkmode.js' %}" defer></script>
    <!-- Barcode -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js" defer></script>
</head>
<body>
{% include 'partials/topbar.html' %}
{% include 'partials/sidebar.html' %}
<br>
<div class="content container py-5">
<div class="d-flex justify-content-end ">
        <button
  id="btnSave"
  type="submit"
  form="productoForm"
  class="btn btn-success save-btn"
  data-bs-toggle="tooltip"
  data-bs-placement="left"
  title="Guardar producto"
>
  <i class="fas fa-save"></i>
</button>
    </div>
    <div class="card mx-auto" style="max-width: 900px;">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h3 class="mb-0">
                {% if form.instance.pk %}
                    <i class="fas fa-edit me-2"></i>Editar Producto
                {% else %}
                    <i class="fas fa-plus-circle me-2"></i>Crear Nuevo Producto
                {% endif %}
            </h3>
        </div>
        <div class="card-body">
            <form id="productoForm" method="post" enctype="multipart/form-data" novalidate>
                {% csrf_token %}

                {# — Campos Principales reordenados — #}
                <div class="row g-4 mb-4">
                    <div class="col-md-6">
                        <label class="form-label">Código de Barras o Referencia<span
                                class="text-danger">*</span></label>
                        {{ form.codigo_barras|attr:"placeholder:Ingresar código"|add_class:"form-control" }}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Nombre<span class="text-danger">*</span></label>
                        {{ form.nombre|attr:"placeholder:Nombre del producto"|add_class:"form-control" }}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Categoría<span class="text-danger">*</span></label>
                        {{ form.categoria|add_class:"form-select" }}
                        <div class="mt-3">
                            <label class="form-label">Imagen del Producto</label>
                            <label for="{{ form.imagen.id_for_label }}" class="btn btn-outline-primary w-100 mb-2">
                                <i class="fas fa-upload me-1"></i>Subir imagen
                            </label>
                            {{ form.imagen|add_class:"form-control-file d-none" }}
                            <div class="mt-3 text-center">
                                <img id="preview-img"
                                        {% if form.instance.imagen %} src="{{ form.instance.imagen.url }}"{% endif %}
                                     class="img-thumbnail d-block mx-auto"
                                     style="max-width:150px; {% if not form.instance.imagen %}display:none;{% endif %}">
                            </div>

                        </div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Descripción</label>
                        {{ form.descripcion|attr:"placeholder:Descripción detallada"|add_class:"form-control" }}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Precio compra</label>
                        {{ form.precio_compra|attr:"placeholder:0.00"|add_class:"form-control" }}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Precio venta</label>
                        {{ form.precio_venta|attr:"placeholder:0.00"|add_class:"form-control" }}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Stock actual</label>
                        {{ form.stock_actual|attr:"placeholder:0"|add_class:"form-control" }}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Stock mínimo</label>
                        {{ form.stock_minimo|attr:"placeholder:0"|add_class:"form-control" }}
                    </div>
                </div>

                {# — Sección de Atributos (formset) con checkboxes — #}
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <!-- Checkbox general -->
                            <input type="checkbox" id="selectAllAttributes" class="form-check-input me-2">
                            <h5 class="mb-0">Atributos del Producto</h5>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" id="add-atributo" class="btn btn-sm btn-primary">
                                <i class="fas fa-plus me-1"></i>Agregar atributo
                            </button>
                            <button type="button" id="delete-atributos" class="btn btn-sm btn-danger" disabled>
                                <i class="fas fa-trash-alt me-1"></i>Eliminar seleccionados
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        {{ atributo_formset.management_form }}
                        <div id="atributos-container">
                            {% for subform in atributo_formset.forms %}
                                <div class="atributo-form mb-3 border p-3 position-relative">
                                    {# checkbox de selección #}
                                    <input type="checkbox" class="attr-checkbox form-check-input mb-2">
                                    {{ subform.id }}
                                    <div class="row g-3">
                                        <div class="col-md-5">
                                            <label class="form-label">Atributo</label>
                                            {{ subform.atributo|add_class:"form-select atributo-select" }}
                                        </div>
                                        <div class="col-md-5">
                                            <label class="form-label">Opción</label>
                                            {{ subform.opcion|add_class:"form-select opcion-select" }}
                                        </div>
                                        {# ocultamos el DELETE pero lo mantenemos para el formset #}
                                        {{ subform.DELETE|add_class:"d-none" }}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

            </form>


        </div>

    </div>

</div>

<!-- JS al final -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Prefijo y totalForms desde management_form
        const prefix = "{{ atributo_formset.prefix }}",
            totalForms = document.getElementById(`id_${prefix}-TOTAL_FORMS`),
            container = document.getElementById('atributos-container'),
            addBtn = document.getElementById('add-atributo'),
            deleteBtn = document.getElementById('delete-atributos'),
            selectAll = document.getElementById('selectAllAttributes');

        // Mapeo atributo → opciones
        const opcionesMap = {
            {% for atributo in atributos %}
                "{{ atributo.id }}": [
                    {% for opt in atributo.opciones.all %}
                        {id: "{{ opt.id }}", valor: "{{ opt.valor|escapejs }}"},
                    {% endfor %}
                ],
            {% endfor %}
        };

        // Actualiza estado del botón eliminar
        function updateDeleteButton() {
            const anyChecked = Array.from(document.querySelectorAll('.attr-checkbox'))
                .some(cb => cb.checked);
            deleteBtn.disabled = !anyChecked;
            updateSelectAll();
        }

        // Actualiza estado del checkbox “Seleccionar todos”
        function updateSelectAll() {
            const all = Array.from(document.querySelectorAll('.attr-checkbox'));
            const checked = all.filter(cb => cb.checked);
            selectAll.checked = all.length > 0 && checked.length === all.length;
        }

        // Bindeo de selects y checkboxes en cada atributo
        function bindFormEvents(div) {
            const selAtr = div.querySelector('.atributo-select'),
                selOpt = div.querySelector('.opcion-select'),
                cb = div.querySelector('.attr-checkbox'),
                delCbx = div.querySelector(`input[name$="-DELETE"]`);

            selAtr.addEventListener('change', () => {
                const aid = selAtr.value;
                selOpt.innerHTML = '<option value="">Seleccionar...</option>';
                selOpt.disabled = !aid;
                if (aid) {
                    opcionesMap[aid].forEach(o => {
                        const opt = document.createElement('option');
                        opt.value = o.id;
                        opt.textContent = o.valor;
                        selOpt.append(opt);
                    });
                }
            });

            // checkbox individual
            cb.addEventListener('change', updateDeleteButton);
        }

        // Bindeo inicial
        document.querySelectorAll('.atributo-form').forEach(div => {
            bindFormEvents(div);
        });

        // Al agregar nuevo atributo
        addBtn.addEventListener('click', () => {
            const idx = parseInt(totalForms.value, 10),
                wrapper = document.createElement('div');
            wrapper.className = 'atributo-form mb-3 border p-3 position-relative';
            wrapper.innerHTML = `
        <input type="checkbox" class="attr-checkbox form-check-input mb-2">
        <div class="row g-3">
          <div class="col-md-5">
            <label class="form-label">Atributo</label>
            <select name="${prefix}-${idx}-atributo"
                    id="id_${prefix}-${idx}-atributo"
                    class="form-select atributo-select">
              <option value="">Seleccionar atributo...</option>
              {% for atributo in atributos %}
                <option value="{{ atributo.id }}">{{ atributo.nombre }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-5">
            <label class="form-label">Opción</label>
            <select name="${prefix}-${idx}-opcion"
                    id="id_${prefix}-${idx}-opcion"
                    class="form-select opcion-select"
                    disabled>
              <option value="">Seleccionar...</option>
            </select>
          </div>
        </div>
        <input type="hidden" name="${prefix}-${idx}-id" id="id_${prefix}-${idx}-id">
        <input type="checkbox" name="${prefix}-${idx}-DELETE" id="id_${prefix}-${idx}-DELETE" hidden>
      `;
            container.append(wrapper);
            totalForms.value = idx + 1;
            bindFormEvents(wrapper);
        });

        // Eliminar seleccionados
        deleteBtn.addEventListener('click', () => {
            document.querySelectorAll('.attr-checkbox:checked').forEach(cb => {
                const formDiv = cb.closest('.atributo-form'),
                    delCbx = formDiv.querySelector(`input[name$="-DELETE"]`);
                if (delCbx) delCbx.checked = true;
                formDiv.classList.add('d-none');
                cb.checked = false;
            });
            updateDeleteButton();
        });

        // Al cambiar el checkbox “Seleccionar todos”
        selectAll.addEventListener('change', () => {
            document.querySelectorAll('.attr-checkbox')
                .forEach(cb => {
                    if (!cb.disabled) cb.checked = selectAll.checked;
                });
            updateDeleteButton();
        });

        // Vista previa de imagen
        const inputImg = document.getElementById('{{ form.imagen.id_for_label }}'),
            preview = document.getElementById('preview-img');
        if (inputImg && preview) {
            inputImg.addEventListener('change', e => {
                const file = e.target.files[0];
                if (!file) {
                    preview.style.display = 'none';
                    return;
                }
                const reader = new FileReader();
                reader.onload = ev => {
                    preview.src = ev.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            });
        }

        // Inicializa estado “Seleccionar todos”
        updateSelectAll();
        updateDeleteButton();
    });
</script>
</body>
</html>

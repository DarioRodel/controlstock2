{% load static %}
{% load widget_tweaks %}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Productos – InventarioPro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap & FontAwesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- CSS compartido -->
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'css/producto_list.css' %}">
    <link rel="stylesheet" href="{% static 'css/bars.css' %}">

    <!-- Darkmode & Barcode -->
    <script src="{% static 'dark/js/darkmode.js' %}" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js" defer></script>

</head>
<body>

<!-- Topbar y Sidebar izquierdo -->
{% include 'partials/topbar.html' %}
{% include 'partials/sidebar.html' %}

<!-- Contenido principal -->
<div class="content container-fluid py-4">
    {% block content %}
        <!-- Header -->
         <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-primary mb-0 fs-2">
          <i class="fas fa-boxes me-2 fs-3"></i> Productos
        </h2>

        <div class="d-flex gap-2">
          <!-- Botón filtros -->
          <button class="btn btn-outline-primary" id="openFilterSidebar">
            <i class="fas fa-filter me-1"></i> Filtros
          </button>

          <!-- Botón borrar seleccionados -->
           <form id="bulkDeleteForm"
       method="post"
      action="{% url 'stock:producto_list' %}">
            {% csrf_token %}
            <button type="submit"
                    class="btn btn-outline-danger"
                    id="bulkDeleteBtn"
                    disabled>
              <i class="fas fa-trash-alt"></i> Eliminar seleccionados
            </button>
          </form>
        </div>
      </div>





       <!-- Tabla con checkboxes -->
        <div class="card border-0 shadow-sm">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light text-uppercase small text-muted">
                <tr>
                  <th class="text-center">
                    <input type="checkbox" id="selectAll">
                  </th>
                  <th><i class="fas fa-image me-2"></i>Imagen</th>
                  <th><i class="fas fa-barcode me-2"></i>Código</th>
                  <th><i class="fas fa-signature me-2"></i>Nombre</th>
                  <th><i class="fas fa-folder-open me-2"></i>Categoría</th>
                  <th><i class="fas fa-tags me-2"></i>Atributos</th>
                  <th><i class="fas fa-cubes me-2"></i>Stock</th>
                  <th><i class="fas fa-shield-alt me-2"></i>Estado</th>
                  <th><i class="fas fa-cogs me-2"></i>Acciones</th>
                </tr>
              </thead>
              <tbody>
                {% for producto in productos %}
                  <tr class="text-center">
                    <td>
                      <input type="checkbox"
                             class="row-checkbox"
                             name="selected_products"
                             value="{{ producto.pk }}">
                    </td>
                    <td>
                      {% if producto.imagen %}
                        <img src="{{ producto.imagen.url }}"
                             class="img-thumbnail rounded-circle"
                             style="width:50px;height:50px;object-fit:cover;">
                      {% else %}
                        <i class="fas fa-camera text-muted"></i>
                      {% endif %}
                    </td>
                    <td>{{ producto.codigo_barras }}</td>
                    <td>{{ producto.nombre }}</td>
                    <td>
                      <span class="badge rounded-pill"
                            style="background-color:{{ producto.categoria.color|default:'#ccc' }};color:#fff;">
                        {{ producto.categoria.nombre|default:"—" }}
                      </span>
                    </td>
                    <td>
                      {% for pa in producto.productoatributo_set.all %}
                        <span class="badge rounded-pill"
                              style="background-color:{{ pa.opcion.color|default:'#eee' }};color:#000;">
                          {{ pa.opcion.valor }}
                        </span>
                      {% endfor %}
                    </td>
                    <td>{{ producto.stock_actual }}</td>
                    <td>{{ producto.get_estado_display }}</td>
                    <td>
                      <a href="{% url 'stock:producto_edit' producto.pk %}"
                         class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-edit"></i>
                      </a>

                  </tr>
                {% empty %}
                  <tr>
                    <td colspan="9" class="text-center py-5 text-muted">
                      ¡No hay productos!
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </form>
        <div class="dropdown mb-3">
  <button class="btn btn-secondary dropdown-toggle" type="button"
          id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
    <i class="fas fa-file-export me-2"></i>Exportar Productos
  </button>
  <ul class="dropdown-menu" aria-labelledby="exportDropdown"
      data-bs-flip="false" data-bs-boundary="viewport">
    <li>
      <a class="dropdown-item"
         href="{% url 'stock:export_productos_csv' %}?search={{ request.GET.search }}&categoria={{ request.GET.categoria }}&estado={{ request.GET.estado }}">
        <i class="fas fa-file-csv me-2"></i>CSV
      </a>
    </li>
    <li>
      <a class="dropdown-item"
         href="{% url 'stock:export_productos_excel' %}?search={{ request.GET.search }}&categoria={{ request.GET.categoria }}&estado={{ request.GET.estado }}">
        <i class="fas fa-file-excel me-2"></i>Excel
      </a>
    </li>
    <li>
      <a class="dropdown-item"
         href="{% url 'stock:export_productos_pdf' %}?search={{ request.GET.search }}&categoria={{ request.GET.categoria }}&estado={{ request.GET.estado }}">
        <i class="fas fa-file-pdf me-2"></i>PDF
      </a>
    </li>
  </ul>
</div>

        <!-- Paginación -->
        {% if is_paginated %}
            <nav class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link"
                               href="?page={{ page_obj.previous_page_number }}&{{ request.GET.urlencode }}">‹</a>
                        </li>
                    {% endif %}
                    {% for num in page_obj.paginator.page_range %}
                        <li class="page-item {% if page_obj.number == num %}active{% endif %}">
                            <a class="page-link" href="?page={{ num }}&{{ request.GET.urlencode }}">{{ num }}</a>
                        </li>
                    {% endfor %}
                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link"
                               href="?page={{ page_obj.next_page_number }}&{{ request.GET.urlencode }}">›</a>
                        </li>
                    {% endif %}
                </ul>
            </nav>

        {% endif %}
    {% endblock %}
</div>

<!-- Sidebar derecha: filtros -->
<aside class="filter-sidebar" id="filterSidebar">
    <div class="tabs">
        <i class="fas fa-filter active" id="tabProductFilters" title="Filtros de Productos"></i>
        <i class="fas fa-columns" id="tabColumnFilters" title="Filtros de Columnas"></i>
    </div>
    <!-- PRODUCT FILTERS -->
    <div class="filters-panel" id="productFilters">
        <h5>Filtrar Productos</h5>
        <form id="formProductFilters" method="get">
            <div class="mb-3">
                <label class="form-label">Buscar</label>
                <input type="text" name="search" class="form-control"
                       value="{{ request.GET.search }}">
            </div>
            <div class="mb-3">
                <label class="form-label">Categoría</label>
                <select name="categoria" class="form-select">
                    <option value="">Todas</option>
                    {% for cat in categorias %}
                        <option value="{{ cat.id }}"
                                {% if request.GET.categoria == cat.id|stringformat:"s" %}selected{% endif %}>
                            {{ cat.nombre }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Estado</label>
                <select name="estado" class="form-select">
                    <option value="">Todos</option>
                    {% for valor,nombre in estados %}
                        <option value="{{ valor }}" {% if request.GET.estado == valor %}selected{% endif %}>
                            {{ nombre }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Atributo</label>
                <select name="atributo" class="form-select">
                    <option value="">Todos</option>
                    {% for atributo in atributos %}
                        <option value="{{ atributo.id }}"
                                {% if request.GET.atributo == atributo.id|stringformat:"s" %}selected{% endif %}>
                            {{ atributo.nombre }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Opciones</label>
                <div>
                    {% if opciones %}
                        {% for opcion in opciones %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox"
                                       name="opcion" value="{{ opcion.id }}"
                                       id="opt{{ opcion.id }}"
                                       {% if opcion.id|stringformat:"s" in opciones_seleccionadas %}checked{% endif %}>
                                <label class="form-check-label" for="opt{{ opcion.id }}">
                                    {{ opcion.valor }}
                                </label>
                            </div>
                        {% endfor %}
                    {% else %}
                        <small class="text-muted">Selecciona un atributo</small>
                    {% endif %}
                </div>
            </div>
            <button type="submit" class="btn btn-primary w-100">
                <i class="fas fa-filter me-1"></i> Aplicar
            </button>
        </form>
    </div>
    <!-- COLUMN FILTERS -->
    <div class="filters-panel hidden" id="columnFilters">
        <h5>Filtrar Columnas</h5>
        <ul class="list-unstyled">
            {% for col in available_columns %}
                <li class="form-check">
                    <input class="form-check-input column-toggle" type="checkbox"
                           value="{{ col.key }}" id="col{{ col.key }}" data-column="{{ col.key }}"
                           checked>
                    <label class="form-check-label" for="col{{ col.key }}">
                        {{ col.label }}
                    </label>
                </li>
            {% endfor %}
        </ul>
    </div>
    <div class="clear-btn">
        <i class="fas fa-eraser" id="clearFilters" title="Limpiar Filtros"></i>
    </div>
</aside>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
     document.addEventListener('DOMContentLoaded', () => {
      const selectAll     = document.getElementById('selectAll'),
            rowCheckboxes = document.querySelectorAll('.row-checkbox'),
            bulkBtn       = document.getElementById('bulkDeleteBtn'),
            bulkForm      = document.getElementById('bulkDeleteForm'),
            productsForm  = document.getElementById('productsForm');

      function updateBulkButton() {
        const anyChecked = Array.from(rowCheckboxes).some(cb => cb.checked);
        bulkBtn.disabled = !anyChecked;
      }

      // select all / none
      selectAll.addEventListener('change', () => {
        rowCheckboxes.forEach(cb => cb.checked = selectAll.checked);
        updateBulkButton();
      });

      rowCheckboxes.forEach(cb => {
        cb.addEventListener('change', () => {
          // si alguno desmarca, descheckea el selectAll
          if (!cb.checked) selectAll.checked = false;
          // si todos marcados, checkea selectAll
          else if (Array.from(rowCheckboxes).every(x => x.checked)) selectAll.checked = true;
          updateBulkButton();
        });
      });

      // cuando envíes el bulkForm, inyecta en él los selected_products
      bulkForm.addEventListener('submit', e => {
        e.preventDefault();
        // limpia inputs anteriores
        Array.from(bulkForm.querySelectorAll('input[name="selected_products"]')).forEach(i=>i.remove());
        // clona los checked del productsForm
        rowCheckboxes.forEach(cb => {
          if (cb.checked) {
            const hidden = document.createElement('input');
            hidden.type  = 'hidden';
            hidden.name  = 'selected_products';
            hidden.value = cb.value;
            bulkForm.append(hidden);
          }
        });
        bulkForm.submit();
      });
    });
    document.addEventListener('DOMContentLoaded', () => {
        const filterSidebar = document.getElementById('filterSidebar'),
            openBtn = document.getElementById('openFilterSidebar'),
            tabProd = document.getElementById('tabProductFilters'),
            tabCols = document.getElementById('tabColumnFilters'),
            panelProd = document.getElementById('productFilters'),
            panelCols = document.getElementById('columnFilters'),
            clearBtn = document.getElementById('clearFilters');

        // Abrir/cerrar sidebar
        openBtn.addEventListener('click', () => {
            filterSidebar.classList.toggle('open');
        });

        // Cambiar pestañas
        [tabProd, tabCols].forEach(tab => {
            tab.addEventListener('click', () => {
                tabProd.classList.toggle('active', tab === tabProd);
                tabCols.classList.toggle('active', tab === tabCols);
                panelProd.classList.toggle('hidden', tab !== tabProd);
                panelCols.classList.toggle('hidden', tab !== tabCols);
            });
        });

        // Limpiar filtros
        clearBtn.addEventListener('click', () => {
            document.getElementById('formProductFilters').reset();
            document.querySelectorAll('.column-toggle').forEach(chk => {
                chk.checked = true;
                document.querySelectorAll(`[data-column="${chk.value}"]`)
                    .forEach(el => el.style.display = '');
            });
        });

        // Toggle columnas
        document.querySelectorAll('.column-toggle').forEach(chk => {
            chk.addEventListener('change', () => {
                document.querySelectorAll(`[data-column="${chk.value}"]`)
                    .forEach(el => el.style.display = chk.checked ? '' : 'none');
            });
        });

        // Cerrar al hacer clic fuera
        document.addEventListener('click', e => {
            if (!filterSidebar.contains(e.target) && !openBtn.contains(e.target)) {
                filterSidebar.classList.remove('open');
            }
        });
    });
</script>
</body>
</html>
